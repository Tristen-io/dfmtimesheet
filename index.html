<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timecard Maker</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2canvas & jsPDF for exports -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    /* Mobile tap targets */
    button, input, select { touch-action: manipulation; }
    /* Hide number input spinners (if any appear in some browsers) */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/60 shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-semibold">ðŸ•’ Timecard Maker</h1>
      <div class="text-xs md:text-sm text-slate-500">Local-only â€¢ Works offline</div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-24 pt-4">
    <!-- App Card -->
    <section class="bg-white rounded-2xl shadow-sm ring-1 ring-slate-200 p-4 md:p-6">
      <!-- Date & Actions -->
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div class="flex flex-col md:flex-row md:items-center gap-3">
          <label class="text-sm font-medium">Date
            <input id="dateInput" type="date" class="mt-1 md:mt-0 md:ml-2 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 px-3 py-2" />
          </label>
          <label class="text-sm font-medium">Job / Notes
            <input id="jobNotes" type="text" placeholder="(optional)" class="mt-1 md:mt-0 md:ml-2 w-full md:w-80 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 px-3 py-2" />
          </label>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="addRowBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-700 active:scale-[.99]">Add Row</button>
          <button id="clearDayBtn" class="px-4 py-2 rounded-xl bg-slate-100 text-slate-700 font-medium hover:bg-slate-200 active:scale-[.99]">Clear Day</button>
        </div>
      </div>

      <!-- Roster helper -->
      <details class="mt-4 group">
        <summary class="cursor-pointer select-none text-sm text-slate-600 hover:text-slate-800 flex items-center gap-2">
          <span class="inline-block w-4 text-center group-open:rotate-90 transition">â–¶</span>
          Manage Employee Roster (saves to your device)
        </summary>
        <div class="mt-3 grid md:grid-cols-2 gap-3">
          <div class="bg-slate-50 rounded-xl p-3 ring-1 ring-slate-200">
            <label class="text-sm font-medium">Add employee to roster</label>
            <div class="mt-2 flex gap-2">
              <input id="rosterName" type="text" placeholder="Full name" class="flex-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 px-3 py-2" />
              <button id="addRosterBtn" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium">Add</button>
            </div>
            <p class="text-xs text-slate-500 mt-2">Tip: Added names appear as suggestions in the Name field below.</p>
          </div>
          <div class="bg-slate-50 rounded-xl p-3 ring-1 ring-slate-200">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium">Current roster</span>
              <button id="clearRosterBtn" class="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200">Clear roster</button>
            </div>
            <ul id="rosterList" class="mt-2 text-sm grid grid-cols-1 sm:grid-cols-2 gap-1"></ul>
          </div>
        </div>
      </details>

      <!-- Table -->
      <div id="captureArea" class="mt-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold">Timecard</h2>
          <div id="dateLabel" class="text-sm text-slate-500"></div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-100 text-slate-700">
              <tr>
                <th class="p-2 text-left">#</th>
                <th class="p-2 text-left">Name</th>
                <th class="p-2">Driver</th>
                <th class="p-2">Start</th>
                <th class="p-2">End</th>
                <th class="p-2 text-right">Hours</th>
                <th class="p-2 text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
            <tfoot>
              <tr class="border-t">
                <td colspan="5" class="p-2 text-right font-medium">Total Hours</td>
                <td id="totalHours" class="p-2 text-right font-semibold">0.00</td>
                <td class="p-2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="mt-2 text-sm text-slate-600" id="jobNotesEcho"></div>
      </div>

      <!-- Export buttons -->
      <div class="mt-4 flex flex-wrap gap-2">
        <button id="exportCSV" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700">Export CSV</button>
        <button id="exportPDF" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-700">Export PDF</button>
        <button id="exportPNG" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-medium hover:bg-slate-950">Download PNG</button>
        <button id="copyPNG" class="px-4 py-2 rounded-xl bg-slate-100 text-slate-800 font-medium hover:bg-slate-200">Copy as Image</button>
      </div>

      <p class="mt-3 text-xs text-slate-500">Your data is stored locally in your browser (localStorage). No accounts, no servers.</p>
    </section>

    <!-- Mini FAQ -->
    <section class="mt-6 text-sm text-slate-600">
      <h3 class="font-semibold mb-2">Tips</h3>
      <ul class="list-disc ml-5 space-y-1">
        <li>Tap <span class="font-medium">Add Row</span> to add workers for the selected day. Use the <span class="font-medium">Driver</span> toggle per person.</li>
        <li>Time supports overnight shifts: if End is earlier than Start, it counts as next day.</li>
        <li>Use <span class="font-medium">Export PDF</span> or <span class="font-medium">Download PNG</span> for easy send/print/screenshot on iPhone/Android.</li>
        <li>Roster lets you pre-save names and quickly type/select them in rows (use your keyboardâ€™s name suggestions).</li>
      </ul>
    </section>
  </main>

  <template id="rowTemplate">
    <tr class="border-b last:border-0">
      <td class="p-2 align-middle indexCell"></td>
      <td class="p-2 align-middle">
        <input type="text" list="rosterDatalist" placeholder="Employee name" class="nameInput w-full rounded-lg border-slate-300 px-2 py-1 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
      </td>
      <td class="p-2 text-center align-middle">
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" class="driverInput w-4 h-4" />
          <span class="text-xs text-slate-600">Driver</span>
        </label>
      </td>
      <td class="p-2 text-center align-middle">
        <input type="time" class="startInput rounded-lg border-slate-300 px-2 py-1 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
      </td>
      <td class="p-2 text-center align-middle">
        <input type="time" class="endInput rounded-lg border-slate-300 px-2 py-1 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
      </td>
      <td class="p-2 text-right align-middle hoursCell font-medium">0.00</td>
      <td class="p-2 text-right align-middle">
        <button class="deleteBtn text-xs px-3 py-1 rounded-lg bg-rose-50 text-rose-700 hover:bg-rose-100">Delete</button>
      </td>
    </tr>
  </template>

  <datalist id="rosterDatalist"></datalist>

  <script>
    // --- Utilities ---
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    function fmtHours(n){ return (Math.round(n * 100) / 100).toFixed(2); }
    function parseHM(v){
      if(!v) return null;
      const [h,m] = v.split(":").map(Number);
      return h*60 + m;
    }
    function diffHours(start, end){
      const s = parseHM(start); const e = parseHM(end);
      if(s==null || e==null) return 0;
      let mins = e - s;
      if(mins < 0) mins += 24*60; // overnight
      return mins/60;
    }

    // --- Local Storage Keys ---
    const LS_KEYS = {
      ROSTER: 'timecard_roster_v1',
      DAY: 'timecard_day_v1'
    };

    // --- State ---
    let roster = JSON.parse(localStorage.getItem(LS_KEYS.ROSTER) || '[]');

    function saveRoster(){ localStorage.setItem(LS_KEYS.ROSTER, JSON.stringify(roster)); renderRoster(); renderRosterDatalist(); }
    function renderRoster(){
      const ul = $('#rosterList');
      ul.innerHTML = '';
      roster.forEach((name, idx)=>{
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-white rounded-lg px-2 py-1 ring-1 ring-slate-200';
        li.innerHTML = `<span>${name}</span>`;
        const del = document.createElement('button');
        del.className = 'text-xs px-2 py-1 rounded-lg bg-rose-50 text-rose-700 hover:bg-rose-100';
        del.textContent = 'Remove';
        del.onclick = ()=>{ roster.splice(idx,1); saveRoster(); };
        li.appendChild(del);
        ul.appendChild(li);
      });
    }
    function renderRosterDatalist(){
      const dl = $('#rosterDatalist');
      dl.innerHTML = roster.map(n=>`<option value="${n}"></option>`).join('');
    }

    // --- Day Data ---
    function currentDateStr(){ return $('#dateInput').value || new Date().toISOString().slice(0,10); }

    function loadDay(){
      const all = JSON.parse(localStorage.getItem(LS_KEYS.DAY) || '{}');
      const key = currentDateStr();
      return all[key] || { date: key, notes: '', rows: [] };
    }
    function saveDay(day){
      const all = JSON.parse(localStorage.getItem(LS_KEYS.DAY) || '{}');
      all[day.date] = day;
      localStorage.setItem(LS_KEYS.DAY, JSON.stringify(all));
    }

    function setDateLabel(){ $('#dateLabel').textContent = new Date(currentDateStr()).toLocaleDateString(); }

    function renderDay(){
      const day = loadDay();
      $('#jobNotes').value = day.notes || '';
      $('#jobNotesEcho').textContent = day.notes ? `Notes: ${day.notes}` : '';
      const tbody = $('#rows');
      tbody.innerHTML = '';
      day.rows.forEach(addRowFromData);
      recalcTotals();
      setDateLabel();
    }

    function addRowFromData(row){
      const tpl = $('#rowTemplate');
      const tr = tpl.content.firstElementChild.cloneNode(true);
      const idx = $('#rows').children.length + 1;
      $('.indexCell', tr).textContent = idx;
      const nameInput = $('.nameInput', tr);
      const driverInput = $('.driverInput', tr);
      const startInput = $('.startInput', tr);
      const endInput = $('.endInput', tr);
      const hoursCell = $('.hoursCell', tr);
      const deleteBtn = $('.deleteBtn', tr);

      // Prefill if provided
      if(row){
        nameInput.value = row.name || '';
        driverInput.checked = !!row.driver;
        startInput.value = row.start || '';
        endInput.value = row.end || '';
      }

      function onChange(){
        const hrs = diffHours(startInput.value, endInput.value);
        hoursCell.textContent = fmtHours(hrs);
        persist();
      }

      [nameInput, driverInput, startInput, endInput].forEach(el=>{
        el.addEventListener('input', onChange);
        el.addEventListener('change', onChange);
      });
      deleteBtn.onclick = ()=>{
        tr.remove();
        renumber();
        persist();
      };

      $('#rows').appendChild(tr);
      onChange();
    }

    function addEmptyRow(){ addRowFromData({}); }

    function renumber(){
      $$('#rows tr').forEach((tr,i)=>{ $('.indexCell', tr).textContent = i+1; });
      recalcTotals();
    }

    function collectDay(){
      const rows = $$('#rows tr').map(tr=>({
        name: $('.nameInput', tr).value.trim(),
        driver: $('.driverInput', tr).checked,
        start: $('.startInput', tr).value,
        end: $('.endInput', tr).value,
        hours: parseFloat($('.hoursCell', tr).textContent) || 0
      })).filter(r=>r.name || r.start || r.end);
      return {
        date: currentDateStr(),
        notes: $('#jobNotes').value.trim(),
        rows
      };
    }

    function persist(){
      const day = collectDay();
      saveDay(day);
      recalcTotals();
      $('#jobNotesEcho').textContent = day.notes ? `Notes: ${day.notes}` : '';
    }

    function recalcTotals(){
      const total = $$('#rows .hoursCell').reduce((sum,td)=> sum + (parseFloat(td.textContent)||0), 0);
      $('#totalHours').textContent = fmtHours(total);
    }

    // --- Exports ---
    function filenameBase(){
      const date = currentDateStr();
      const job = ($('#jobNotes').value || '').trim().replace(/\s+/g,'_').slice(0,40);
      return `timecard_${date}${job?('_'+job):''}`;
    }

    function exportCSV(){
      const day = collectDay();
      const rows = [
        ['Date', day.date],
        ['Notes', day.notes],
        [],
        ['#','Name','Driver','Start','End','Hours']
      ];
      day.rows.forEach((r,i)=>{
        rows.push([i+1, r.name, r.driver ? 'Yes' : 'No', r.start, r.end, r.hours.toFixed(2)]);
      });
      rows.push([]);
      rows.push(['', '', '', '', 'Total', fmtHours(day.rows.reduce((s,r)=>s+r.hours,0))]);

      const csv = rows.map(row=> row.map(cell=>{
        if(cell==null) return '';
        const s = String(cell).replace(/"/g,'""');
        return /[",\n]/.test(s) ? `"${s}"` : s;
      }).join(',')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filenameBase() + '.csv';
      a.click();
    }

    async function exportPNG(copyToClipboard=false){
      const el = $('#captureArea');
      const canvas = await html2canvas(el, {scale: 2, backgroundColor: '#ffffff'});
      if(copyToClipboard && navigator.clipboard && navigator.clipboard.write){
        canvas.toBlob(async (blob)=>{
          try{
            await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
            alert('Image copied to clipboard.');
          }catch(err){
            console.error(err);
            alert('Copy failed. Your browser may block clipboard image writes.');
          }
        });
      } else {
        const link = document.createElement('a');
        link.download = filenameBase()+'.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      }
    }

    async function exportPDF(){
      const { jsPDF } = window.jspdf;
      const el = $('#captureArea');
      const canvas = await html2canvas(el, {scale: 2, backgroundColor: '#ffffff'});
      const imgData = canvas.toDataURL('image/png');

      // Create A4 portrait PDF and fit width
      const pdf = new jsPDF({unit:'pt', format:'a4', compress: true});
      const margin = 24;
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pageWidth - margin*2;
      const imgHeight = canvas.height * (imgWidth / canvas.width);

      let y = margin;
      if(imgHeight < pageHeight - margin*2){
        pdf.addImage(imgData, 'PNG', margin, y, imgWidth, imgHeight, undefined, 'FAST');
      } else {
        // Multi-page if needed
        let hLeft = imgHeight;
        while(hLeft > 0){
          pdf.addImage(imgData, 'PNG', margin, y, imgWidth, imgHeight, undefined, 'FAST');
          hLeft -= (pageHeight - margin*2);
          if(hLeft > 0){
            pdf.addPage();
            y = margin - hLeft; // shift up for next slice
          }
        }
      }
      pdf.save(filenameBase()+'.pdf');
    }

    // --- Event bindings ---
    $('#addRowBtn').onclick = addEmptyRow;
    $('#clearDayBtn').onclick = ()=>{
      if(confirm('Clear all rows for this date?')){
        $('#rows').innerHTML='';
        persist();
        renumber();
      }
    };

    $('#exportCSV').onclick = exportCSV;
    $('#exportPNG').onclick = ()=>exportPNG(false);
    $('#copyPNG').onclick = ()=>exportPNG(true);
    $('#exportPDF').onclick = exportPDF;

    $('#addRosterBtn').onclick = ()=>{
      const name = $('#rosterName').value.trim();
      if(!name) return;
      if(!roster.includes(name)) roster.push(name);
      $('#rosterName').value = '';
      saveRoster();
    };
    $('#clearRosterBtn').onclick = ()=>{
      if(confirm('Clear entire roster from this device?')){
        roster = [];
        saveRoster();
      }
    };

    $('#dateInput').addEventListener('change', ()=>{ setDateLabel(); renderDay(); });
    $('#jobNotes').addEventListener('input', persist);

    // --- Init ---
    (function init(){
      // Default date = today
      const today = new Date().toISOString().slice(0,10);
      $('#dateInput').value = today;
      setDateLabel();
      renderRoster();
      renderRosterDatalist();
      renderDay();
    })();
  </script>
</body>
</html>
